<?php

/* 
    Term to URL dictionaries
*/

// English easy-read dictionary
$GLOBALS["en_easy_urls"] = array(
    "Action Planning" => "/wiki/action-planning-easy/",
    "Blue Referral" => "/wiki/blue-referral-easy/",
    "Buddy System" => "/wiki/buddy-system-easy/",
    "Community Assets" => "/wiki/community-assets-easy/",
    "Community Support Hubs" => "/wiki/community-support-hubs-easy/",
    "Co-Production" => "/wiki/co-production-easy/",
    "Co-Produce" => "/wiki/co-production-easy/",
    "Creative Referral" => "/wiki/creative-referral-easy/",
    "Education on Referral" => "/wiki/education-on-referral-easy/",
    "Exercise Referral" => "/wiki/exercise-referral-easy/",
    "Green Referral" => "/wiki/green-referral-easy/",
    "Holistic" => "/wiki/holistic-easy/",
    "Nature-Based Interventions" => "/wiki/nature-based-interventions-easy/",
    "Person-Centred Approach" => "/wiki/person-centred-approach-easy/",
    "Referral" => "/wiki/referral-easy/",
    "Signposting & Active Signposting" => "/wiki/signposting-active-signposting-easy/",
    "Social Cafes" => "/wiki/social-cafes-easy/",
    "Social Prescribing Pathway" => "/wiki/social-prescribing-practitioner-easy/",
    "Social Prescribing Practitioner" => "/wiki/social-prescribing-practitioner-easy/",
    "Social Prescribing" => "/wiki/social-prescribing-easy/",
    "Welfare Support Referral" => "/wiki/welfare-support-referral-easy/",
    "Wellbeing" => "/wiki/well-being-easy/",
    "What Matters Conversation" => "/wiki/what-matters-conversation-easy/"
);



// Welsh easy-read dictionary
$GLOBALS["cy_easy_urls"] = array(
    "Cynllunio Camau Gweithredu" => "/cy/wiki/action-planning-easy/",
    "Atgyfeirio Glas" => "/cy/wiki/blue-referral-easy/",
    "System Gyfeillio" => "/cy/wiki/buddy-system-easy/",
    "Asedau Cymunedol" => "/cy/wiki/community-assets-easy/",
    "Hybiau Cymorth Cymunedol" => "/cy/wiki/community-support-hubs-easy/",
    "Cydgynhyrchu" => "/cy/wiki/co-production-easy/",
    "Atgyfeirio Creadigol" => "/cy/wiki/creative-referral-easy/",
    "Atgyfeirio at Addysg" => "/cy/wiki/education-on-referral-easy/",
    "Atgyfeirio at Ymarfer Corff" => "/cy/wiki/exercise-referral-easy/",
    "Atgyfeirio Gwyrdd" => "/cy/wiki/green-referral-easy/",
    "Cyfannol" => "/cy/wiki/holistic-easy/",
    "Ymyriadau’n Seiliedig ar Natur" => "/cy/wiki/nature-based-interventions-easy/",
    "Ymyriadau'n Seiliedig ar Natur" => "/cy/wiki/nature-based-interventions-easy/",
    "Dull Person Ganolog o Fynd Ati" => "/cy/wiki/person-centred-approach-easy/",
    "Atgyfeirio" => "/cy/wiki/referral-easy/",
    "Cyfeirio a Chyfeirio Gweithredol" => "/cy/wiki/signposting-active-signposting-easy/",
    "Caffis Cymunedol" => "/cy/wiki/social-cafes-easy/",
    "Llwybr Presgripsiynu Cymdeithasol" => "/cy/wiki/social-prescribing-practitioner-easy/",
    "Ymarferydd Presgripsiynu Cymdeithasol" => "/cy/wiki/social-prescribing-practitioner-easy/",
    "Presgripsiynu Cymdeithasol" => "/cy/wiki/social-prescribing-easy/",
    "Atgyfeirio at Gymorth Lles" => "/cy/wiki/welfare-support-referral-easy/",
    "Llesiant" => "/cy/wiki/well-being-easy/",
    "Sgwrs am Yr Hyn sy’n Bwysig" => "/cy/wiki/what-matters-conversation-easy/",
    "Sgwrs am Yr Hyn sy'n Bwysig" => "/cy/wiki/what-matters-conversation-easy/"
);



// Welsh professional dictionary
$GLOBALS["cy_pro_urls"] = array(
    "Cynllunio Camau Gweithredu" => "/cy/wiki/action-planning/",
    "Dull sy’n Seiliedig ar Asedau" => "/cy/wiki/asset-based-approach/",
    "Dull sy'n Seiliedig ar Asedau" => "/cy/wiki/asset-based-approach/",
    "Mapio Asedau" => "/cy/wiki/asset-mapping/",
    "Atgyfeirio Glas" => "/cy/wiki/blue-referral/",
    "Atgyfeirio at Lyfrau" => "/cy/wiki/books-on-referral/",
    "System Gyfeillio" => "/cy/wiki/buddy-system/",
    "Datblygu’r Practis" => "/cy/wiki/building-the-practice/",
    "Datblygu'r Practis" => "/cy/wiki/building-the-practice/",
    "Llywiwr Gofal" => "/cy/wiki/care-navigator/",
    "Asedau Cymunedol" => "/cy/wiki/community-assets/",
    "Hybiau Cymorth Cymunedol" => "/cy/wiki/community-support-hubs/",
    "Sefydliadau’r Sector Cymunedol a Gwirfoddol" => "/cy/wiki/community-voluntary-sector-organisations/",
    "Sefydliadau'r Sector Cymunedol a Gwirfoddol" => "/cy/wiki/community-voluntary-sector-organisations/",
    "Cydgynhyrchu" => "/cy/wiki/co-production/",
    "cweithgareddau atgyfeirio creadigol" => "/cy/wiki/creative-referral/",
    "Atgyfeirio Creadigol" => "/cy/wiki/creative-referral/",
    "Atgyfeiriad Creadigol" => "/cy/wiki/creative-referral/",
    "Presgripsiynu Cymdeithasol Digidol" => "/cy/wiki/digital-social-prescribing/",
    "Atgyfeirio at Addysg" => "/cy/wiki/education-on-referral/",
    "Atgyfeirio at Ymarfer Corff" => "/cy/wiki/exercise-referral/",
    "Atgyfeirio Gwyrdd" => "/cy/wiki/green-referral/",
    "Hwylusydd Iechyd" => "/cy/wiki/health-facilitator/",
    "Cyfannol" => "/cy/wiki/holistic/",
    "Ymyriadau’n Seiliedig ar Natur" => "/cy/wiki/nature-based-interventions/",
    "Ymyriadau'n Seiliedig ar Natur" => "/cy/wiki/nature-based-interventions/",
    "Dull Person Ganolog o Fynd Ati" => "/cy/wiki/person-centred-approach-2/",
    "dull sy’n canolbwyntio ar yr unigolyn" => "/cy/wiki/person-centred-approach-2/",
    "Cynllun dan Reolaeth Practis" => "/cy/wiki/practice-managed-scheme/",
    "cynlluniau dan reolaeth practis" => "/cy/wiki/practice-managed-scheme/",
    "Cyfeirio a Chyfeirio Gweithredol" => "/cy/wiki/active-signposting/",
    "Caffis Cymunedol" => "/cy/wiki/social-cafes/",
    "caffis cymdeithasol" => "/cy/wiki/social-cafes/",
    "Dulliau Presgripsiynu Cymdeithasol" => "/cy/wiki/social-prescribing-approach/",
    "Hyrwyddwr Presgripsiynu Cymdeithasol" => "/cy/wiki/social-prescribing-champion/",
    "Model Presgripsiynu Cymdeithasol" => "/cy/wiki/social-prescribing-models/",
    "Modelau Presgripsiynu Cymdeithasol" => "/cy/wiki/social-prescribing-models/",
    "Egwyddorion Canlyniad Presgripsiynu Cymdeithasol" => "/cy/wiki/social-prescribing-outcome-principles/",
    "Llwybr Presgripsiynu Cymdeithasol" => "/cy/wiki/social-prescribing-pathway/",
    "Ymarferydd Presgripsiynu Cymdeithasol" => "/cy/wiki/social-prescribing-practitioner/",
    "Gwasanaethau Statudol" => "/cy/wiki/statutory-services/",
    "Atgyfeirio at Gymorth Lles" => "/cy/wiki/welfare-support-referral/",
    "Llesiant" => "/cy/wiki/well-being/",
    "Sgwrs am Yr Hyn sy’n Bwysig" => "/cy/wiki/what-matters-conversation/",
    "Sgwrs am Yr Hyn sy'n Bwysig" => "/cy/wiki/what-matters-conversation/",
    "Atgyfeirio" => "/cy/wiki/referral/",
    "Atgyfeiriad" => "/cy/wiki/referral/",
    "cyfeirio" => "/cy/wiki/referral/",
    "ymgymryd â phresgripsiynu cymdeithasol" => "/cy/wiki/social-prescribing/",
    "bresgripsiynu cymdeithasol" => "/cy/wiki/social-prescribing/",
    "Presgripsiynnu Cymdeithasol" => "/cy/wiki/social-prescribing/",
    "Presgripsiynu Cymdeithasol" => "/cy/wiki/social-prescribing/"
);

 

/*
    Functions needed for WSSPR Wiki to operate
*/

/**
 * Checks if a string contains a word.
 * @param $str string to check
 * @param $word string to find
 * @return bool true if found, false if not found
 */
function contains_word($str, $word)
{
    if (strpos($str, $word) !== false) return true;
    else return false;
}

/**
 * Creates a HTML anchor (<a></a>)
 * @param $str Text to go inside anchor
 * @param $href Hyperlink for the anchor
 * @return string Text with anchor surrounding it
 */
function a($str, $href = "")
{
    return "<a href=\"".$href."\">".$str."</a>";
}

/**
 * Creates span with colour
 * @param $str Text to go inside span
 * @param $col Colour to use
 * @return string Text with colour span surrounding it
 */
function col($str, $col = "")
{
    return "<span style=\"color: ".$col.";\">".$str."</span>";
}

/**
 * Simple markdown to HTML intepreter
 * @param $markdown Markdown raw text to intepret to HTML
 * @return string HTML intepreted from markdown
 */
function intepret_markdown($markdown)
{
    // Passes for bold text
    $markdown = preg_replace_callback('/\*\*/', function($m) use (&$count) { ++$count; return $count % 2 ? '<strong>' : '</strong>'; }, $markdown);
    $markdown = preg_replace_callback('/__/', function($m) use (&$count) { ++$count; return $count % 2 ? '<strong>' : '</strong>'; }, $markdown);

    // Pass for superscript
    $markdown = preg_replace_callback('/\^\^/', function($m) use (&$count) { ++$count; return $count % 2 ? '<sup>' : '</sup>'; }, $markdown);

    // Pass for colour declarations (CUSTOM)
    preg_match_all('/\$\[(.*?)\]\((.*?)\)/', $markdown, $out, PREG_PATTERN_ORDER);
    for ($i = 0; $i < count($out[0]); $i++)
    {
        if (!contains_word($out[1][$i], "<") && !contains_word($out[1][$i], "$["))
        {
            $pos = strpos($markdown, $out[0][$i]);
            if (($pos - 1) < 0) continue;
            $prev_char = $markdown[$pos - 1];
            if ($prev_char != " ") continue;

            $markdown = str_replace($out[0][$i], col($out[1][$i], $out[2][$i]), $markdown);
        }
    }

    // Pass for hyperlinks/anchors
    preg_match_all('/\[(.*?)\]\((.*?)\)/', $markdown, $out, PREG_PATTERN_ORDER);
    for ($i = 0; $i < count($out[0]); $i++)
    {
        $markdown = str_replace($out[0][$i], a($out[1][$i], $out[2][$i]), $markdown);
    }
    
    $doing_bullets = false;

    // Pass for line-by-line stuff
    $markdown_arr = explode("\n", $markdown);
    foreach ($markdown_arr as &$line)
    {
        if (strlen($line) > 2)
        {
            // Handle bullet points
            if ($line[0] == "*" && $line[1] == " ")
            {
                $line = "<li>".substr($line, 2, strlen($line))."</li>";
                if (!$doing_bullets)
                {
                    $line = "<ul>".$line;
                    $doing_bullets = true;
                }
            }
        }
        else
        {
            if ($doing_bullets)
            {
                $doing_bullets = false;
                $line = "</ul>".$line;
            }
        }
    }

    // Catch any loose ends from line-by-line processing
    if ($doing_bullets) $line .= "</ul>";

    $markdown = implode("\n", $markdown_arr);

    return $markdown;
}

function str_replace_outside_tags($toReplace = 'inner text', $dummyText = '(REPLACED TEXT HERE)', $sourceText = null)
{
  $string = $sourceText;
  $punctuation = "\.,!\?:;\\|\/=\"#";
  $stringPart = "\b$toReplace\b";
  $excludeSequence = "(?![\w\n\s>$punctuation]*?";
  $excludeOutside = "$excludeSequence<\/)";
  $excludeTag = "$excludeSequence>)";
  $pattern = "/" . $stringPart . $excludeOutside . $excludeTag . "/im";
  
  return preg_replace($pattern, $dummyText, $string);
}

/**
 * Creates hyperlinks for terms within a connected terms
 * string
 * @param $str CSV terms to process
 * @param $dict Term to URL dictionary to use
 * @return string CSV terms with anchors applied
 */
function process_connected_terms($str, $dict)
{
    // Clean the string by removing double spaces, replacing no-break spaces
    // (U+00a0) with real spaces and removing line endings
    $str = str_replace(" ", " ", $str);
    $str = str_replace("  ", " ", $str);
    $str = str_replace(".", "", $str);
    $str = trim(preg_replace('/\s\s+/', ' ', $str));

    $terms = explode(", ", $str);
    asort($terms, SORT_NATURAL);
    
    foreach ($terms as &$term)
    {
        foreach ($dict as $k => $v)
        {
            $term = trim($term, " ");
            if (strtolower($k) == strtolower($term))
            {
                $term = a($term, $v);
                break;
            }
        }
    }

    return implode(", ", $terms);
}

function process_desc_terms($str, $title, $dict)
{
    krsort($dict, SORT_NATURAL);
    foreach($dict as $k => $v)
    {
        if (strtolower($k) == strtolower($title)) continue;
        $a = a(strtolower($k), $v);
        $str = str_replace_outside_tags($k, $a, $str);
    }

    return $str;
}



/*
    WSSPR Wiki meta box processing
*/

/*
    * Meta box processing code for WSSPR Wiki. This will alter the page based on metabox
    * values saved from Yada Wiki posts.
    * 
    * Meta box types:
    *    * ww_en_title - English title
    *    * ww_en_mindmap - English mindmap
    *    * ww_en_desc - English term description
    *    * ww_en_alt - English alternative terms
    *    * ww_en_connected - English connected terms
    *    * ww_cy_title - Welsh title
    *    * ww_cy_mindmap - Welsh mindmap PDF
    *    * ww_cy_desc - Welsh term description
    *    * ww_cy_alt - Welsh alternative terms
    *    * ww_cy_connected - Welsh connected terms
*/
function wsspr_wiki(&$title, &$content)
{
    // Get English meta boxes as the default/fallback
    if (get_post_meta(get_the_ID(), "ww_en_title", true) != "")
        $title = get_post_meta(get_the_ID(), "ww_en_title", true);
    $mindmap = get_post_meta(get_the_ID(), "ww_en_mindmap", true);
    $desc = get_post_meta(get_the_ID(), "ww_en_desc", true);
    $alt = get_post_meta(get_the_ID(), "ww_en_alt", true);
    $connected = get_post_meta(get_the_ID(), "ww_en_connected", true);
    
    if (contains_word($_SERVER['REQUEST_URI'], "-easy"))
    {
        $desc_header = "";
        $alt_header = "<span class='ww-subheading'>Also sometimes called:</span> ";
        $connected_header = "<span class='ww-subheading'>Connected terms:</span> ";
        $connected = process_connected_terms($connected, $GLOBALS["en_easy_urls"]);
    }
    else
    {
        $desc_header = "<span class='ww-subheading'>Description:</span> ";
        $alt_header = "<span class='ww-subheading'>Alternative terms:</span> ";
        $connected_header = "<span class='ww-subheading'>Connected terms:</span> ";

        // If alt or connected are empty, - to indicate to end-user this is normal
        if ($alt == "") $alt = "-";
        if ($connected == "") $connected = "-";
    }

    // If locale is Welsh, replace what we can
    // with Welsh versions
    if (get_locale() == "cy")
    {
        if (get_post_meta(get_the_ID(), "ww_cy_title", true) != "")
            $title = get_post_meta(get_the_ID(), "ww_cy_title", true);
        $mindmap = get_post_meta(get_the_ID(), "ww_cy_mindmap", true);
        $desc = get_post_meta(get_the_ID(), "ww_cy_desc", true);
        $alt = get_post_meta(get_the_ID(), "ww_cy_alt", true);
        $connected = get_post_meta(get_the_ID(), "ww_cy_connected", true);

        if (contains_word($_SERVER['REQUEST_URI'], "-easy"))
        {
            $desc_header = "";
            $alt_header = "<span class='ww-subheading'>Mae hyn weithiau yn cael ei alw yn:</span> ";
            $connected_header = "<span class='ww-subheading'>Termau Cysylltiedig:</span> ";
            $connected = process_connected_terms($connected, $GLOBALS["cy_easy_urls"]);
            $desc = intepret_markdown($desc);
        }
        else
        {
            $desc_header = "<span class='ww-subheading'>Disgrifiad:</span> ";
            $alt_header = "<span class='ww-subheading'>Termau Amgen:</span> ";
            $connected_header = "<span class='ww-subheading'>Termau Cysylltiedig:</span> ";
            $connected = process_connected_terms($connected, $GLOBALS["cy_pro_urls"]);
            $desc = process_desc_terms(intepret_markdown($desc), $title, $GLOBALS["cy_pro_urls"]);

            // If alt or connected are empty, - to indicate to end-user this is normal
            if ($alt == "") $alt = "-";
            if ($connected == "") $connected = "-";
        }
    }
    else $desc = intepret_markdown($desc);

    if ($desc != "")
    {
        $content = $desc_header.$desc."\n\n";
        if ($alt != "") $content .= $alt_header.intepret_markdown($alt)."\n\n";
        if ($connected != "") $content .= $connected_header.$connected."\n\n";

        if ($mindmap != "")
        {
            $content .= "[pdfviewer width=\"100%\" height=\"720px\"]".$mindmap."[/pdfviewer]";
        }
    }
}